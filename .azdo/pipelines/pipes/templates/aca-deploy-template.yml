# ----------------------------------------------------------------------------------------------------
# Template to deploy a Docker image to a Container App
# ----------------------------------------------------------------------------------------------------
# This template gets the appName from the variable group: AI.LZ.Secrets
#   and the resource group name from /vars/var-<env>.yml
# ----------------------------------------------------------------------------------------------------
parameters:
  - name: serviceConnectionName
    type: string
  - name: environmentCode
    default: 'DEV'
    type: string
  - name: containerAppName
    default: ''
    type: string
  - name: acrAppName
    default: ''
    type: string
  - name: port
    default: '8080'
    type: string
  - name: acrFolderName
    default: 'appImages'
    type: string

# ----------------------------------------------------------------------------------------------------
jobs:
  - deployment: InitDeploy${{ parameters.containerAppName }}${{ parameters.environmentcode }}
    displayName: Init Deploy ${{ parameters.containerAppName }} ${{ parameters.environmentcode }}
    environment: ${{ parameters.environmentcode }}

  - job: DeployApp${{ parameters.containerAppName }}${{ parameters.environmentcode }}Job
    displayName: Deploy ${{ parameters.containerAppName }} ${{ parameters.environmentcode }}
    variables:
      - group: AI.LZ.Secrets # need to get the appName from here
      # Bring in environment specific variable files
      - ${{ if eq(lower(parameters.environmentcode), 'dev') }}:
          - template: ../../vars/var-dev.yml
      - ${{ if eq(lower(parameters.environmentcode), 'qa') }}:
          - template: ../../vars/var-qa.yml
      - ${{ if eq(lower(parameters.environmentcode), 'prod') }}:
          - template: ../../vars/var-prod.yml

    steps:
      # ----------------------------------------------------------------------------------------------------
      # Set up the environment variables
      # ----------------------------------------------------------------------------------------------------
      - task: PowerShell@2
        name: createVariables
        displayName: Create Variables
        continueOnError: true
        inputs:
          targetType: 'inline'
          script: |
            $appNameNoDashesLower="$(APP_NAME)".ToLower().Replace("-", "")
            $environmentCodeLower="${{ parameters.environmentcode }}".ToLower()
            $containerAppNameLower="${{ parameters.containerAppName }}".ToLower()
            $acrFolderNameLower="${{ parameters.acrFolderName }}".ToLower()
            $acrAppNameLower="${{ parameters.acrAppName }}".ToLower()

            $resourceGroupName="$(RESOURCEGROUP_PREFIX)-$environmentCodeLower-$(INSTANCE_NUMBER)".ToLower()
            echo "##vso[task.setvariable variable=resourceGroupName]$resourceGroupName"

            $caAppName="ca-ui-$($appNameNoDashesLower)-$($environmentCodeLower)-$(INSTANCE_NUMBER)"
            echo "##vso[task.setvariable variable=caAppName]$caAppName"
            $imageName="$($acrFolderNameLower)/$($acrAppNameLower):$(Build.BuildId)"
            echo "##vso[task.setvariable variable=imageName]$imageName"
            $acrName="cr$($appNameNoDashesLower)$($environmentCodeLower)$(INSTANCE_NUMBER)"
            echo "##vso[task.setvariable variable=acrName]$acrName"
            $containerRegistryUrl="cr$($appNameNoDashesLower)$($environmentCodeLower)$(INSTANCE_NUMBER).azurecr.io"
            echo "##vso[task.setvariable variable=containerRegistryUrl]$containerRegistryUrl"

            echo "environmentCodeLower=$environmentCodeLower"
            echo "appNameNoDashesLower=$appNameNoDashesLower"
            echo "resourceGroupName=$resourceGroupName"
            echo "containerAppNameLower=$containerAppNameLower"
            echo "acrFolderNameLower=$acrFolderNameLower"
            echo "acrAppNameLower=$acrAppNameLower"
            echo "caAppName=$caAppName"
            echo "containerRegistryUrl=$containerRegistryUrl"
            echo "imageName=$imageName"
            echo "acrName=$acrName"

            echo "----------------------------------------"
            echo "##[group]Display All Environment Variables:"
            printenv | sort
            echo "##[endgroup]"

      # # ----------------------------------------------------------------------------------------------------
      # # Log into ACR
      # # ----------------------------------------------------------------------------------------------------
      # - task: AzureCLI@2
      #   displayName: 'ACR: Docker Login'
      #   inputs:
      #     AzureSubscription: $(serviceConnectionName)
      #     scriptType: bash
      #     scriptLocation: inlineScript
      #     inlineScript: |
      #       echo "Logging in to $(acrName)"
      #       az acr login -n $(acrName)

      # ----------------------------------------------------------------------------------------------------
      # Deploy the container app image
      # ----------------------------------------------------------------------------------------------------
      - task: AzureCLI@2
        displayName: Deploy Container App
        inputs:
          AzureSubscription: $(serviceConnectionName)
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az containerapp update \
              --name $(caAppName) \
              --resource-group $(resourceGroupName) \
              --image $(containerRegistryUrl)/$(imageName) \
              --container-name app

