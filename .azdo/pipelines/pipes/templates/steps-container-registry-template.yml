# ----------------------------------------------------------------------------------------------------
# Steps Template to Add or Remove the Agent IP from the Container Registry FW
# ----------------------------------------------------------------------------------------------------
# Usage:
# - template: steps-container-registry-firewall-template.yml
#   parameters:
#     action: 'add' or 'add-login' or 'push' or 'add-login-push-remove' or 'remove'
#     serviceConnectionName: $(serviceConnectionName)
#     registryName: $(registryName)
#     registryResourceGroup: $(registryResourceGroup)
#     imageName: $(imageName)
#     updateFirewall: true/false
#     agentIpAddress: $(agentIpAddress)
# ----------------------------------------------------------------------------------------------------

parameters:
  - name: action
    default: 'add' # 'add' or 'add-login' or 'push' or 'add-login-push-remove' or 'remove'
  - name: environmentCode
    default: ''
  - name: serviceConnectionName
    default: ''
  - name: registryName
    default: ''
  - name: registryResourceGroup
    default: ''
  - name: imageName
    default: ''
  - name: imageNameLatest
    default: ''
  - name: updateFirewall
    default: true
  - name: agentIpAddress
    default: ''

steps:
  # # If you want to get the IP Address here, do one of these...
  # - task: PowerShell@2
  #   name: createVariables
  #   displayName: Create Variables PS
  #   continueOnError: true
  #   inputs:
  #     targetType: 'inline'
  #     script: |
  #       $agentIpAddress = $(Invoke-WebRequest -Uri "https://api.ipify.org").Content
  #       echo "##vso[task.setvariable variable=agentIpAddress]$agentIpAddress"
  # - bash: |
  #     agentIpAddress=`curl -s http://ifconfig.me/ip`
  #     echo "agentIpAddress=$agentIpAddress"
  #     echo "##vso[task.setvariable variable=agentIpAddress]$agentIpAddress"
  #   displayName: Create Variables Bash

  - task: PowerShell@2
    displayName: Create Variables
    continueOnError: true
    inputs:
      targetType: 'inline'
      script: |
        $environmentCodeLower="${{ parameters.environmentCode }}".ToLower()
        $appNameLowerNoDashes="$(APP_NAME)".ToLower().Replace("-", "")

        if ([string]::IsNullOrEmpty("${{ parameters.registryName }}")) {
          $containerRegistryName=("cr$($appNameLowerNoDashes)$($environmentCodeLower)$(INSTANCE_NUMBER)").ToLower()
        } else {
          $containerRegistryName="${{ parameters.registryName }}"
        }
        echo "##vso[task.setvariable variable=containerRegistryName]$containerRegistryName"
        echo "containerRegistryName=$containerRegistryName"

        if ([string]::IsNullOrEmpty("${{ parameters.registryResourceGroup }}")) {
          $resourceGroupName = ("$(RESOURCEGROUP_PREFIX)-$environmentCodeLower-$(INSTANCE_NUMBER)").ToLower()
        } else {
          $resourceGroupName="${{ parameters.registryResourceGroup }}"
        }
        echo "##vso[task.setvariable variable=resourceGroupName]$resourceGroupName"
        echo "resourceGroupName=$resourceGroupName"

        if ([string]::IsNullOrEmpty("${{ parameters.agentIpAddress }}")) {
          $ipAddress=$(Invoke-WebRequest -Uri "https://api.ipify.org").Content
        } else {
          $ipAddress="${{ parameters.agentIpAddress }}"
        }
        echo "##vso[task.setvariable variable=ipAddress]$ipAddress"
        echo "ipAddress=$ipAddress"

  - task: PowerShell@2
    displayName: Display Variables
    continueOnError: true
    inputs:
      targetType: 'inline'
      script: |
        echo "serviceConnectionName=${{ parameters.serviceConnectionName }}"
        echo "action=${{ parameters.action }}"
        echo "environmentCode=${{ parameters.environmentCode }}"
        echo "imageName=${{ parameters.imageName }}"
        echo "imageNameLatest=${{ parameters.imageNameLatest }}"
        echo "updateFirewall=${{ parameters.updateFirewall }}"

        echo "parameters.registryName=${{ parameters.registryName }}"
        echo "containerRegistryName=$(containerRegistryName)"
        
        echo "parameters.agentIpAddress=${{ parameters.agentIpAddress }}"
        echo "ipAddress=$(ipAddress)"

        echo "parameters.registryResourceGroup=${{ parameters.registryResourceGroup }}"
        echo "resourceGroupName=$(resourceGroupName)"

  - ${{ if and(contains(lower(parameters.action), 'add'), parameters.updateFirewall) }}:
    - task: AzureCLI@2
      displayName: 'ACR: Add Agent FW'
      inputs:
        azureSubscription: ${{ parameters.serviceConnectionName }}
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Executing: az acr network-rule add --name $(containerRegistryName) --resource-group $(resourceGroupName) --ip-address $(ipAddress)"
          az acr network-rule add --name $(containerRegistryName) --resource-group $(resourceGroupName) --ip-address $(ipAddress)

  # ----------------------------------------------------------------------------------------------------
  # Deploy with docker push - log in with service connection identity - it must have acrpush rights...
  # ----------------------------------------------------------------------------------------------------
  # You could also authorize using this instead of the az acr login:
  #   echo $(ContainerRegistryPassword) | docker login $(ContainerRegistryUrl) -u $(ContainerRegistryUserName) --password-stdin
  # ----------------------------------------------------------------------------------------------------
  - ${{ if contains(lower(parameters.action), 'login') }}:
    - task: AzureCLI@2
      displayName: 'ACR: Docker Login'
      inputs:
        AzureSubscription: $(serviceConnectionName)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Logging in to $(containerRegistryName).azurecr.io"
          az acr login -n $(containerRegistryName)

  - ${{ if contains(lower(parameters.action), 'push') }}:
    - task: AzureCLI@2
      displayName: 'ACR: Docker Push ${{ parameters.imageName }}'
      inputs:
        AzureSubscription: $(serviceConnectionName)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Pushing ${{ parameters.imageName }} to $(containerRegistryName).azurecr.io/${{ parameters.imageName }}"
          docker tag ${{ parameters.imageName }} $(containerRegistryName).azurecr.io/${{ parameters.imageName }}
          docker push $(containerRegistryName).azurecr.io/${{ parameters.imageName }}

          echo "Pushing ${{ parameters.imageNameLatest }} to $(containerRegistryName).azurecr.io/${{ parameters.imageNameLatest }}"
          docker tag ${{ parameters.imageName }} $(containerRegistryName).azurecr.io/${{ parameters.imageNameLatest }}
          docker push $(containerRegistryName).azurecr.io/${{ parameters.imageNameLatest }}

  - ${{ if and(contains(lower(parameters.action), 'remove'), parameters.updateFirewall) }}:
    - task: AzureCLI@2
      displayName: 'ACR: Remove Agent FW'
      inputs:
        azureSubscription: ${{ parameters.serviceConnectionName }}
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Executing: az acr network-rule remove --name $(containerRegistryName) --resource-group $(resourceGroupName) --ip-address $(ipAddress)"
          az acr network-rule remove --name $(containerRegistryName) --resource-group $(resourceGroupName) --ip-address $(ipAddress)
